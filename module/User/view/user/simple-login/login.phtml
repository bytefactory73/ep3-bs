<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <?= $this->render('user/simple-login/apple-webapp-meta') ?>
    <link rel="stylesheet" href="../css/simple-mode.css" />
    <style>
    body, html {
        min-height: 100vh;
        height: auto;
        overflow-x: hidden;
    }
    .simple-login-bg {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #e3f0fa 0%, #fafdff 100%);
        z-index: -1;
        width: 100vw;
        min-height: 100vh;
        height: 100%;
    }
    .simple-login-frame {
        max-width: 350px;
        margin: 8vh auto 0 auto;
        background: #fafdff;
        border-radius: 18px;
        box-shadow: 0 4px 32px rgba(33,150,243,0.10), 0 1.5px 6px rgba(33,150,243,0.08);
        padding: 36px 32px 28px 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1.5px solid #2196f3;
    }
    .simple-login-frame h1 {
        color: #2196f3;
        font-size: 2em;
        margin-bottom: 18px;
        font-weight: bold;
        text-align: center;
    }
    .simple-login-frame label {
        font-size: 1.1em;
        color: #333;
        margin-bottom: 8px;
        font-weight: 500;
        display: block;
        text-align: left;
    }
    .simple-login-frame input[type="password"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1.5px solid #b0c4de;
        font-size: 1.1em;
        margin-bottom: 18px;
        outline: none;
        transition: border 0.2s;
    }
    .simple-login-frame input[type="password"]:focus {
        border-color: #2196f3;
    }
    .simple-login-frame button[type="submit"] {
        width: 100%;
        background: #2196f3;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 0;
        font-size: 1.15em;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(33,150,243,0.08);
        transition: background 0.18s;
        margin-top: 6px;
    }
    .simple-login-frame button[type="submit"]:hover {
        background: #1769aa;
    }
    .simple-login-frame .error-message {
        color: #d32f2f;
        background: #fff3f3;
        border: 1px solid #d32f2f;
        border-radius: 6px;
        padding: 8px 12px;
        margin-bottom: 16px;
        width: 100%;
        text-align: center;
        font-size: 1em;
    }
    .simple-login-frame form {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .simple-login-frame input[type="text"] {
        width: 100%;
        max-width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1.5px solid #b0c4de;
        font-size: 1.1em;
        margin-bottom: 18px;
        outline: none;
        transition: border 0.2s;
        box-sizing: border-box;
        text-align: center;
    }
    .simple-login-frame input[type="text"]:focus {
        border-color: #2196f3;
    }
    @media (max-width: 500px) {
        .simple-login-frame {
            max-width: 98vw;
            padding: 18px 6vw 18px 6vw;
        }
    }
    .simple-order-history-frame {
        max-width: 350px;
        margin: 8vh auto 0 auto;
        background: #fafdff;
        border-radius: 18px;
        box-shadow: 0 4px 32px rgba(33,150,243,0.10), 0 1.5px 6px rgba(33,150,243,0.08);
        padding: 36px 32px 28px 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1.5px solid #2196f3;
    }
    .simple-order-history-frame h1 {
        color: #2196f3;
        font-size: 2em;
        margin-bottom: 18px;
        font-weight: bold;
        text-align: center;
    }
    </style>
</head>
<body>
<div class="simple-login-bg"></div>
<header style="width:100vw;text-align:center;padding:2.5vh 0 1.5vh 0;">
    <span style="font-size:2.1em;font-weight:bold;color:#2196f3;letter-spacing:0.5px;">STC Butzbach - SB-Theke</span>
</header>
<div class="simple-login-frame">
    <?php if (!empty($this->error)): ?>
        <div class="error-message"> <?= $this->escapeHtml($this->error) ?> </div>
    <?php endif; ?>
    <form method="post" autocomplete="off" id="simple-login-form">
        <input type="text" id="alias-mask" autocomplete="off" inputmode="text" spellcheck="false" required autofocus placeholder="Theken ID">
        <input type="hidden" name="alias" id="real-alias">
        <button type="submit">Login</button>
    </form>
    <script>
    (function() {
        var maskInput = document.getElementById('alias-mask');
        var realInput = document.getElementById('real-alias');
        window._realAlias = '';
        maskInput.addEventListener('input', function(e) {
            var prev = window._realAlias;
            var masked = maskInput.value;
            // Figure out what changed
            if (masked.length < prev.length) {
                // Character(s) deleted
                window._realAlias = prev.substring(0, masked.length);
            } else {
                // Character(s) added
                var added = masked.length - prev.length;
                var inputChar = e.data || '';
                if (added > 0 && inputChar) {
                    window._realAlias += inputChar;
                } else if (added > 0) {
                    // Fallback: can't detect, just append *
                    window._realAlias += '*'.repeat(added);
                }
            }
            maskInput.value = '*'.repeat(window._realAlias.length);
        });
        maskInput.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                window._realAlias = window._realAlias.slice(0, -1);
            }
        });
        maskInput.addEventListener('paste', function(e) {
            e.preventDefault();
            var paste = (e.clipboardData || window.clipboardData).getData('text');
            window._realAlias += paste;
            maskInput.value = '*'.repeat(window._realAlias.length);
        });

        // Standalone mode form submit fix for iOS
        document.getElementById('simple-login-form').addEventListener('submit', function(e) {
            realInput.value = window._realAlias || '';
            if (window.navigator.standalone) {
                e.preventDefault();
                var form = e.target;
                var xhr = new XMLHttpRequest();
                xhr.open('POST', form.action || window.location.pathname, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        // Replace the page content with the response
                        document.open();
                        document.write(xhr.responseText);
                        document.close();
                    } else {
                        // fallback: reload
                        window.location.reload();
                    }
                };
                var params = 'alias=' + encodeURIComponent(realInput.value);
                xhr.send(params);
            }
        });
    })();
    </script>
</div>
<div class="simple-login-info" style="max-width:350px;width:100%;background:#e3f0fa;border-radius:12px;border:1.5px solid #2196f3;padding:18px 22px;color:#1769aa;font-size:1.08em;text-align:center;box-shadow:0 2px 12px rgba(33,150,243,0.07);margin:18px auto 0 auto;">
    Logge dich mit deiner <b>"Theken-ID"</b> ein. Diese kannst du in deinem Benutzer Profil des Buchungssystem selbst w√§hlen.
</div>
<div class="simple-order-history-frame" style="max-width:350px;margin:18px auto 0 auto;background:#fafdff;border-radius:18px;box-shadow:0 4px 32px rgba(33,150,243,0.10), 0 1.5px 6px rgba(33,150,243,0.08);padding:36px 32px 28px 32px;display:flex;flex-direction:column;align-items:center;border:1.5px solid #2196f3;">
    <h1>Buchungshistorie</h1>
    <table style="font-size:1em; border-collapse:collapse; margin-bottom:24px; margin-left:auto; margin-right:auto; min-width:0; width:auto; max-width:100%;">
        <thead>
            <tr style="background:#e3f0fa; color:#1769aa;">
                <th colspan="2" style="padding:0; border:none; background:none;"></th>
                <th style="padding:0; border:none; background:none;"></th>
            </tr>
        </thead>
        <tbody>
        <?php
        if (!empty($this->recentOrders)):
            // Group orders by date and alias
            $grouped = [];
            foreach ($this->recentOrders as $row) {
                $dt = new DateTime($row['order_time']);
                $date = $dt->format('Y-m-d');
                $alias = $row['alias'];
                $drink = $row['drink_name'];
                $isDeleted = isset($row['deleted']) && $row['deleted'];
                $deletedKey = $isDeleted ? 'deleted' : 'active';
                if (!isset($grouped[$date])) $grouped[$date] = [];
                if (!isset($grouped[$date][$alias])) $grouped[$date][$alias] = ['drinks' => [], 'deleted' => $isDeleted, 'order_time' => $row['order_time']];
                // If any order for this group is deleted, mark as deleted
                $grouped[$date][$alias]['deleted'] = $grouped[$date][$alias]['deleted'] || $isDeleted;
                $grouped[$date][$alias]['order_time'] = min($grouped[$date][$alias]['order_time'], $row['order_time']);
                if (!isset($grouped[$date][$alias]['drinks'][$drink])) {
                    $grouped[$date][$alias]['drinks'][$drink] = 0;
                }
                $grouped[$date][$alias]['drinks'][$drink] += (int)$row['quantity'];
            }
            // Sort by date descending, then by order_time ascending
            krsort($grouped);
            foreach ($grouped as $date => $aliases) {
                $firstAlias = true;
                $datePrinted = false;
                foreach ($aliases as $alias => $info) {
                    $dt = new DateTime($info['order_time']);
                    $strikeOpen = $info['deleted'] ? '<span style="text-decoration:line-through; color:#b0b0b0;">' : '';
                    $strikeClose = $info['deleted'] ? '</span>' : '';
                    $drinks = [];
                    foreach ($info['drinks'] as $drinkName => $qty) {
                        $drinks[] = (int)$qty . ' x ' . $this->escapeHtml($drinkName);
                    }
                    $drinksLine = implode('<br>', $drinks);
                    if (!$datePrinted) {
        ?>
    <tr>
        <td colspan="3" style="padding:8px 2px; color:#1769aa; font-weight:bold; background:#e3f0fa; text-align:center; font-size:1.08em;">
            <?= $strikeOpen . $dt->format('d.m.Y') . $strikeClose ?>
        </td>
    </tr>
<?php
                        $datePrinted = true;
                    }
?>
    <tr style="border-bottom:1px solid #e3f0fa;">
        <td colspan="2" style="padding:4px 2px; color:#2196f3; font-weight:bold; vertical-align: top;"> <?= $strikeOpen . $this->escapeHtml($alias) . $strikeClose ?> </td>
        <td style="padding:4px 2px; color:#333;"> <?= $strikeOpen . $drinksLine . $strikeClose ?> </td>
    </tr>
<?php
                }
            }
        else: ?>
            <tr><td colspan="3" style="text-align:center; color:#888; padding:10px;">Keine Bestellungen in den letzten 24 Stunden.</td></tr>
        <?php endif; ?>
        </tbody>
    </table>
</div>
</body>
</html>
